syntax = "proto3";

package ipc;

option go_package = "github.com/mithrel/ginkgo/internal/ipc/pb";

import "google/protobuf/timestamp.proto";

message Entry {
  string id = 1;
  int64 version = 2;
  string title = 3;
  string body = 4;
  repeated string tags = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
  string namespace = 8;
}

message NoteAdd { string title = 1; string body = 2; repeated string tags = 3; string namespace = 4; }
message NoteEdit { string id = 1; int64 if_version = 2; string title = 3; string body = 4; repeated string tags = 5; string namespace = 6; }
message NoteDelete { string id = 1; string namespace = 2; }
message NoteShow { string id = 1; string namespace = 2; }

message ListFilter {
  string namespace = 1;
  repeated string tags_any = 2;
  repeated string tags_all = 3;
  google.protobuf.Timestamp since = 4;
  google.protobuf.Timestamp until = 5;
  int32 limit = 6;
  string cursor = 7;
  bool reverse = 8;
  bool include_body = 9;
}

message SearchFTS { string query = 1; ListFilter filter = 2; }
message SearchRegex { string pattern = 1; ListFilter filter = 2; }

message TagList {
  string namespace = 1;
}

message Request {
  oneof cmd {
    NoteAdd note_add = 1;
    NoteEdit note_edit = 2;
    NoteDelete note_delete = 3;
    NoteShow note_show = 4;
    ListFilter note_list = 5;
    SearchFTS note_search_fts = 6;
    SearchRegex note_search_regex = 7;
    SyncRun sync_run = 8;
    QueueRequest queue_list = 9;
    NamespaceList namespace_list = 10;
    TagList tag_list = 11;
    NamespaceDelete namespace_delete = 12;
  }
}

message TagStat {
  string tag = 1;
  int32 count = 2;
  string description = 3;
}

message Response {
  bool ok = 1;
  string msg = 2;
  Entry entry = 3;
  repeated Entry entries = 4;
  repeated QueueRemote queue = 5;
  repeated string namespaces = 6;
  repeated TagStat tags = 7;
  Page page = 8;
}

message Page {
  string next = 1;
  string prev = 2;
}

message RepEvent {
  google.protobuf.Timestamp time = 1;
  string type = 2;
  string id = 3;
  string namespace_id = 4;
  string payload_type = 5;
  bytes payload = 6;
  string signer_id = 7;
  bytes sig = 8;
}

message PushBatch {
  repeated RepEvent events = 1;
}

message ItemStatus {
  string id = 1;
  bool ok = 2;
  string msg = 3;
}

message Cursor {
  google.protobuf.Timestamp after = 1;
}

message PushResult {
  repeated ItemStatus items = 1;
  Cursor next = 2;
}

message PullResult {
  repeated RepEvent events = 1;
  Cursor next = 2;
}

message SyncRun {}
message NamespaceList {}
message NamespaceDelete { string namespace = 1; }

message QueueRequest { int32 limit = 1; string remote = 2; }

message QueueEvent {
  google.protobuf.Timestamp time = 1;
  string type = 2;
  string id = 3;
}

message QueueRemote {
  string name = 1;
  string url = 2;
  int64 pending = 3;
  repeated QueueEvent events = 4;
}
