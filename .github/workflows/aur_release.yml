name: release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to create (e.g., v1.3.0)"
        required: true
      notes:
        description: "Release notes markdown content"
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    env:
      TAG: ${{ inputs.tag }}
      NOTES: ${{ inputs.notes }}
      AUR_REPO: "ssh://aur@aur.archlinux.org/ginkgo-cli.git"
    steps:
      - name: Install build + release deps
        run: |
          pacman -Syu --noconfirm --needed \
            base-devel git openssh github-cli pacman-contrib namcap go

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mark workspace as safe for git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory /tmp/aur

      - name: Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate docs
        run: |
          make docs
          if ! ls docs/man/*.1 >/dev/null 2>&1; then
            echo "docs/man/*.1 missing after docs generation"
            exit 1
          fi
          if ! git diff --quiet; then
            git add -f docs/man docs/markdown
            git commit -m "docs: regenerate"
            git push origin HEAD
          fi
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "Working tree not clean after docs commit"
            exit 1
          fi

      - name: Create and push tag
        run: |
          if [[ "$TAG" != v* ]]; then
            echo "Tag must start with 'v' (e.g., v1.3.0)"
            exit 1
          fi
          if ! ls docs/man/*.1 >/dev/null 2>&1; then
            echo "docs/man/*.1 missing; refusing to tag"
            exit 1
          fi
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists locally"
          else
            git tag -a "$TAG" -m "$TAG"
          fi
          if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists on origin"
          else
            git push origin "$TAG"
          fi

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          printf '%s\n' "$NOTES" > /tmp/RELEASE.md
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file /tmp/RELEASE.md

      - name: Prepare PKGBUILD update for AUR
        run: |
          set -euo pipefail
          PKGVER="${TAG#v}"
          echo "PKGVER=${PKGVER}" >> "$GITHUB_ENV"

      - name: Configure SSH for AUR
        run: |
          install -d -m 700 /root/.ssh
          echo "${AUR_SSH_KEY}" > /root/.ssh/id_ed25519
          chmod 600 /root/.ssh/id_ed25519
          ssh-keyscan -H aur.archlinux.org >> /root/.ssh/known_hosts
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}

      - name: Update AUR repo (PKGBUILD + .SRCINFO)
        run: |
          set -euo pipefail
          git clone "$AUR_REPO" /tmp/aur
          cd /tmp/aur
          git pull --rebase origin master
          useradd -m -u 1000 builder
          chown -R builder:builder /tmp/aur
          if [ ! -f PKGBUILD ]; then
            echo "PKGBUILD not found in AUR repo"
            exit 1
          fi
          runuser -u builder -- sed -i "s/^pkgver=.*/pkgver=${PKGVER}/" PKGBUILD
          runuser -u builder -- sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          runuser -u builder -- updpkgsums
          runuser -u builder -- makepkg -od --noprepare
          runuser -u builder -- makepkg --printsrcinfo > .SRCINFO
          git add PKGBUILD .SRCINFO
          if git diff --cached --quiet; then
            echo "No PKGBUILD changes to commit"
            exit 0
          fi
          git commit -m "upstream release ${PKGVER}"
          git push origin HEAD
